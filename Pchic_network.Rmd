---
title: "Pchic_network"
author: Alexis Hucteau
date: "`r Sys.Date()`"
output:
    html_document:
      toc: yes
      toc_float: yes
      theme: united
editor_options:
  markdown:
    wrap: sentence
---

```{r}
rm(list = ls())

suppressPackageStartupMessages({
  library(dplyr)
  library(chaser)
  library(stringr)
  library(gridExtra)
  library(grid)
  library(ggplot2)
  library(GenomicRanges)
  library(ChAMP)
})

source("~/Core_scripts/core_functions.R")
source("~/GitHub/Multiplex_DNAmet_PPI_Chrom_Coexp/Make_koichi_factor.R")

```

```{r}
prepare_pchic <- function(cell_lines = "all", minimum_interaction = 5){
  load("/media/alexis/DATA/pchic.RData")
  if (length(cell_lines) >= 1){
    cell_lines = c("Mon", "Mac0", "Mac1", "Mac2", "Neu", "MK", "EP", "Ery", "FoeT", "nCD4", "tCD4", "aCD4", "naCD4", "nCD8", "tCD8", "nB", "tB")
  }
  pchic <- data.frame(pchic[rowSums(pchic[,cell_lines] >= minimum_interaction) >= 1, 1:10]) %>% na.omit(.)
  colnames(pchic)[c(1:5, 6:10)] <- rep(c("chr", "start", "end", "ID", "Name"), 2)
  return(pchic)
}

pchic <- prepare_pchic(cell_lines = c("Mon", "Mac1", "Mac0", "Mac2", "MK", "Ery", "EP"))

Pchic_edges <- pchic[,c(4,9)]
colnames(Pchic_edges) <- c("source", "target")

DMP_NR_R_annotated <- readRDS("/media/alexis/DATA/Koichi_methylation_dat/DMP_annotated_analysis.rds")
DMP_NR_R_annotated$DMP_Good_vs_Bad_Baseline$Good_Responder_to_Bad_Responder$logFC <- DMP_NR_R_annotated$DMP_Good_vs_Bad_Baseline$Good_Responder_to_Bad_Responder$Bad_Responder_AVG - DMP_NR_R_annotated$DMP_Good_vs_Bad_Baseline$Good_Responder_to_Bad_Responder$Good_Responder_AVG

DMP_NR_R <- DMP_NR_R_annotated$DMP_Good_vs_Bad_Baseline$Good_Responder_to_Bad_Responder %>% dplyr::select(., c(rowname, logFC, P.Value, ID))
DMP_NR_R <- na.omit(DMP_NR_R)

pchic_net <- dplyr::filter(Pchic_edges, source %in% DMP_NR_R$ID | target %in% DMP_NR_R$ID)

# write.table(pchic_net, "~/GitHub/Multiplex_DNAmet_PPI_Chrom_Coexp/Results/Pchic/pchic_NR_R_network.tsv", sep = "\t", row.names = F, quote = F)
# write.table(DMP_NR_R,  "~/GitHub/Multiplex_DNAmet_PPI_Chrom_Coexp/Results/Pchic/pchic_NR_R_meth_features.tsv", sep = "\t", row.names = F, quote = F)

```

```{r}
load("/media/alexis/DATA/Session/BMIQ_Koichi.RData")
load("/media/alexis/DATA/Session/Methylation_Koichi_analysis.RData")

myGSEA <- champ.GSEA(beta=BMIQ_Koichi, DMP=DMP_Res_vs_NonRes_Koichi$R_to_NR, DMR=DMR_Res_vs_NonRes_Koichi$BumphunterDMR, arraytype="EPIC",adjPval=0.05, method="fisher")
```









```{r}
pchic_gene_network <- pchic[,1:5] %>% unique() %>% dplyr::filter(ID %in% c(pchic_net$source, pchic_net$target))
pchic_gene_network <- tidyr::separate_rows(pchic_gene_network, Name, sep = ";")
pchic_gene_network <- unique(pchic_gene_network)
pchic_gene_network <- pchic_gene_network[,c("ID", "Name")]
colnames(pchic_gene_network) <- c("source", "target")

pchic_gene_network <- dplyr::filter(pchic_gene_network, target %ni% c("snoU13", "Y_RNA"))
write.table(pchic_gene_network,"Results/Pchic/pchic_fragment_gene_network.tsv", sep = "\t", row.names = F, quote = F)
```

